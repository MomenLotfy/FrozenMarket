<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل الدخول - فروزن ماركت</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link href="../css/style.css" rel="stylesheet">

  <style>
    

    body { 
      font-family: "Tajawal", "Segoe UI", sans-serif; 
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-yellow) 100%); 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin: 0; 
      padding: 15px;
      color: var(--text-dark);
      line-height: 1.6;
    }
    
    
  </style>
</head>
<body>
  <!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
    <a href="#" id="openSidebar" class="bottom-nav-item">
        <ion-icon name="grid-outline"></ion-icon>
    </a>
    
   <a href="pages/Cart.html" class="bottom-nav-item position-relative">
    <ion-icon name="cart-outline"></ion-icon>
    <span id="mobile-cart-count" class="mobile-cart-count">0</span>
</a>

    
    <a href="index.html" class="bottom-nav-item active">
        <ion-icon name="home-outline"></ion-icon>
    </a>
    
    <a href="pages/wishlist.html" class="bottom-nav-item">
        <ion-icon name="heart-outline"></ion-icon>
    </a>
    
    <a href="pages/signup&signup.html" class="bottom-nav-item">
        <ion-icon name="person-outline"></ion-icon>
    </a>
</div>



<!-- Sidebar (RTL) -->
<div id="sidebar" class="sidebar">
    <div class="sidebar-content">
        <h2 class="sidebar-title">الأقسام</h2>
        <nav class="sidebar-links">
            <a href="pages/products.html#honey"><i class="fas fa-jar"></i> العسل</a>
            <a href="pages/products.html#butter"><i class="fas fa-cheese"></i> الزبدة</a>
            <a href="pages/products.html#mozzarella"><i class="fas fa-pizza-slice"></i> الموتزاريلا</a>
            <a href="pages/products.html#nuts"><i class="fas fa-seedling"></i> المكسرات</a>
            <a href="pages/products.html#chicken"><i class="fas fa-drumstick-bite"></i> الفراخ</a>
            <a href="pages/products.html#meat"><i class="fas fa-hotdog"></i> اللحوم</a>
            <a href="pages/products.html#fish"><i class="fas fa-fish"></i> الأسماك</a>
        </nav>

        <div class="sidebar-text">
            <h3>فروزن ماركت</h3>
            <p>نسعى لتقديم أفضل المنتجات الطازجة والعالية الجودة لعملائنا الكرام بأسعار مناسبة وخدمة متميزة.</p>
        </div>

        <div class="sidebar-social">
            <p>تابعنا</p>
            <a href="https://www.facebook.com/share/1CBX1XvNHf/" class="facebook" title="فيسبوك">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://wa.me/201008064581" class="whatsapp" title="واتساب">
                            <i class="fab fa-whatsapp"></i>
                        </a>
        </div>
    </div>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>



<div class="auth-container">
  <div class="auth-header">
    <h3>فروزن ماركت</h3>
    <p>مرحباً بك! من فضلك قم بتسجيل الدخول أو أنشئ حساب جديد</p>
  </div>

  <!-- تحذير وضع المحاكاة -->
  <div id="emulatorWarning" class="firebase-emulator-warning hidden">
    <i class="fas fa-exclamation-triangle"></i>
    <span>وضع المحاكاة مفعل - للتجربة فقط</span>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="authTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" id="signin-tab" data-bs-toggle="tab" data-bs-target="#signin">تسجيل الدخول</button></li>
    <li class="nav-item"><button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup">إنشاء حساب</button></li>
  </ul>

  <!-- Forms -->
  <div class="tab-content">
    <!-- Sign In -->
    <div class="tab-pane fade show active" id="signin">
      <form id="signin-form">
        <div class="input-group">
          <i class="fa fa-envelope input-icon"></i>
          <input type="email" class="form-control" id="loginEmail" placeholder="البريد الإلكتروني" required>
        </div>
        <div class="input-group">
          <i class="fa fa-lock input-icon"></i>
          <input type="password" class="form-control" id="loginPassword" placeholder="كلمة المرور" required>
        </div>
        <div class="d-flex justify-content-between mb-3">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="remember">
            <label class="form-check-label" for="remember">تذكرني</label>
          </div>
          <a href="#" id="forgot-password" class="text-warning">نسيت كلمة المرور؟</a>
        </div>
        <button type="submit" class="btn btn-primary-custom w-100" id="loginBtn">
          تسجيل الدخول
        </button>
        <div id="loginMsg"></div>
      </form>
    </div>

    <!-- Sign Up -->
    <div class="tab-pane fade" id="signup">
      <form id="registerForm">
        <div class="input-group">
          <i class="fa fa-user input-icon"></i>
          <input id="regName" type="text" class="form-control" placeholder="الاسم الكامل" required>
        </div>
        <div class="input-group">
          <i class="fa fa-envelope input-icon"></i>
          <input id="regEmail" type="email" class="form-control" placeholder="البريد الإلكتروني" required>
        </div>
        <div class="password-strength" id="passwordStrength"></div>
        <div class="input-group">
          <i class="fa fa-lock input-icon"></i>
          <input id="regPassword" type="password" class="form-control" placeholder="كلمة المرور (6 أحرف على الأقل)" required minlength="6">
        </div>

        <div class="input-group">
          <i class="fa fa-phone input-icon"></i>
          <input id="regPhone" type="tel" class="form-control" placeholder="رقم الهاتف">
        </div>
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="agreeTerms" required>
          <label class="form-check-label" for="agreeTerms">
            أوافق على <a href="#" class="text-warning">الشروط والأحكام</a>
          </label>
        </div>
        <button type="submit" class="btn btn-primary-custom w-100" id="registerBtn">
          إنشاء حساب
        </button>
        <div id="regMsg"></div>
      </form>
    </div>
  </div>


  <!-- Social Login -->
  <div class="social-login">
    <button class="btn-google" id="googleLoginBtn">
      <i class="fab fa-google"></i> 
      <span>Google</span>
    </button>
    <button class="btn-facebook" id="facebookLoginBtn">
      <i class="fab fa-facebook-f"></i> 
      <span>Facebook</span>
    </button>
  </div>

  <!-- Footer -->
  <div class="auth-footer">
    <p id="authFooterText">ليس لديك حساب؟ <a href="#" onclick="document.getElementById('signup-tab').click()">سجل الآن</a></p>
  </div>

  <div class="auth-footer mt-3">
  <button id="backBtn" class="btn btn-outline-light w-100">
    <i class="fa fa-arrow-right"></i> رجوع
  </button>
</div>


<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("openSidebar");
  const links   = document.querySelectorAll("#sidebar .sidebar-links a");

  // فتح
  openBtn.addEventListener("click", function (e) {
    e.preventDefault();
    sidebar.classList.add("active");
    overlay.classList.add("active");
  });

  // غلق
  function closeSidebar() {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  }

  overlay.addEventListener("click", closeSidebar);

  // غلق عند الضغط على أي لينك
  links.forEach(link => {
    link.addEventListener("click", () => {
      closeSidebar();
    });
  });
});
</script>

<script>
  // زر الرجوع الذكي
const backBtn = document.getElementById('backBtn');
if (backBtn) {
  backBtn.addEventListener('click', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const from = urlParams.get('from');

    if (from === 'products') {
      window.location.href = "products.html"; // عدلها حسب اسم ملف المنتجات عندك
    } else if (from === 'home') {
      window.location.href = "index.html"; // عدلها حسب الصفحة الرئيسية عندك
    } else {
      // fallback لو مش جاي من حاجة معينة
      window.history.back();
    }
  });
}

</script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    GoogleAuthProvider, 
    FacebookAuthProvider, 
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    sendPasswordResetEmail,
    updateProfile,
    onAuthStateChanged,
    signOut,
    setPersistence,
    browserLocalPersistence,
    connectAuthEmulator
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    serverTimestamp,
    connectFirestoreEmulator 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ⚠️ استبدل هذه القيم بإعدادات مشروعك من Firebase Console
  const firebaseConfig = {
    apiKey: "AIzaSyCFk_WlW4qHcSbsLSHeWUTfGsc5W0FSE8A",
    authDomain: "frozenmarket-5c9df.firebaseapp.com",
    projectId: "frozenmarket-5c9df",
    storageBucket: "frozenmarket-5c9df.firebasestorage.app",
    messagingSenderId: "847658049541",
    appId: "1:847658049541:web:6f4cd551a12d5e45b5bc6c",
    measurementId: "G-32ZC3B3KPT"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // تفعيل وضع المحاكاة للاختبار (إلغاء التعليق عند الحاجة)
  const useEmulator = false; // غير هذه القيمة إلى true لتفعيل المحاكاة
  if (useEmulator && window.location.hostname === "localhost") {
    try {
      connectAuthEmulator(auth, "http://localhost:9099");
      connectFirestoreEmulator(db, "localhost", 8080);
      document.getElementById('emulatorWarning').classList.remove('hidden');
      console.log("🔥 Firebase Emulator connected");
    } catch (error) {
      console.error("Failed to connect to emulator:", error);
    }
  }

  // تفعيل Local Persistence
  setPersistence(auth, browserLocalPersistence);

  // متغيرات للتحكم في التدفق
  let isProcessingAuth = false;
  let redirectInProgress = false;
  let isUserRedirected = false;

  // عناصر DOM
  const loginForm = document.getElementById('signin-form');
  const registerForm = document.getElementById('registerForm');
  const googleBtn = document.getElementById('googleLoginBtn');
  const facebookBtn = document.getElementById('facebookLoginBtn');
  const forgotPasswordLink = document.getElementById('forgot-password');
  const currentUserInfo = document.getElementById('currentUserInfo');

  // التحقق من وجود رسالة تسجيل خروج
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('logout') === 'true') {
    showLogoutNotice();
    // إزالة المعامل من URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // دالة عرض إشعار تسجيل الخروج
  function showLogoutNotice() {
    const notice = document.createElement('div');
    notice.className = 'logout-notice';
    notice.textContent = 'تم تسجيل الخروج بنجاح';
    document.body.appendChild(notice);
    
    setTimeout(() => {
      notice.remove();
    }, 3000);
  }

  // دالة لعرض الرسائل
  function showMessage(elementId, message, type = 'success') {
    const msgElement = document.getElementById(elementId);
    msgElement.textContent = message;
    msgElement.className = type === 'success' ? 'msg-success' : 'msg-error';
    
    if (type === 'error') {
      msgElement.parentElement.classList.add('shake');
      setTimeout(() => msgElement.parentElement.classList.remove('shake'), 600);
    }
    
    setTimeout(() => {
      msgElement.textContent = '';
      msgElement.className = '';
    }, 5000);
  }

  // دالة التحميل
  function setLoading(buttonElement, isLoading) {
    if (isLoading) {
      buttonElement.disabled = true;
      const originalText = buttonElement.innerHTML;
      buttonElement.dataset.originalText = originalText;
      buttonElement.innerHTML = originalText + '<span class="spinner"></span>';
    } else {
      buttonElement.disabled = false;
      if (buttonElement.dataset.originalText) {
        buttonElement.innerHTML = buttonElement.dataset.originalText;
      }
    }
  }

  // دالة الانتقال الآمن للبروفايل
  function redirectToProfile() {
    if (redirectInProgress || isUserRedirected) return;
    redirectInProgress = true;
    isUserRedirected = true;
    
    sessionStorage.setItem('justLoggedIn', 'true');
    window.location.href = "ProfilePage.html";

  }

  // دالة حفظ/تحديث بيانات المستخدم
  async function saveUserToFirestore(user, isNewUser = false, additionalData = {}) {
    try {
      const userDoc = doc(db, "users", user.uid);
      
      // إذا كان مستخدم جديد أو لا يوجد له بيانات
      if (isNewUser) {
        const userData = {
          uid: user.uid,
          name: user.displayName || additionalData.name || "مستخدم جديد",
          email: user.email,
          phone: user.phoneNumber || additionalData.phone || "",
          photoURL: user.photoURL || "",
          role: "user",
          registerDate: new Date().toLocaleDateString('ar-EG'),
          createdAt: serverTimestamp(),
          lastLoginAt: serverTimestamp(),
          loginMethod: additionalData.loginMethod || "email",
          isEmailVerified: user.emailVerified,
          stats: {
            ordersCount: 0,
            totalSpent: 0,
            lastOrderAt: null
          },
          addresses: {
            primary: "",
            secondary: ""
          },
          preferences: {
            deliveryTime: "أي وقت",
            notifications: {
              email: true,
              sms: true,
              promotional: false,
              orderStatus: true
            }
          }
        };
        
        await setDoc(userDoc, userData);
        console.log("New user saved to Firestore");
      } else {
        // تحديث آخر تسجيل دخول فقط
        await setDoc(userDoc, {
          lastLoginAt: serverTimestamp(),
          isEmailVerified: user.emailVerified
        }, { merge: true });
      }
    } catch (error) {
      console.error("Error saving user to Firestore:", error);
    }
  }

  // دالة التحقق من كون المستخدم جديد
  async function isNewUser(user) {
    try {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      return !userDoc.exists();
    } catch (error) {
      console.error("Error checking if user is new:", error);
      return true; // في حالة الخطأ، نعتبره مستخدم جديد
    }
  }

  // دالة معالجة الأخطاء
  function getErrorMessage(errorCode, context = 'general') {
    const errorMessages = {
      // أخطاء عامة
      'auth/network-request-failed': 'خطأ في الاتصال بالإنترنت',
      'auth/too-many-requests': 'محاولات كثيرة جداً، حاول مرة أخرى لاحقاً',
      'auth/operation-not-allowed': 'هذه العملية غير مسموحة',
      
      // أخطاء تسجيل الدخول
      'auth/user-not-found': 'لا يوجد حساب بهذا البريد الإلكتروني',
      'auth/wrong-password': 'كلمة المرور غير صحيحة',
      'auth/invalid-email': 'البريد الإلكتروني غير صحيح',
      'auth/user-disabled': 'هذا الحساب معطل',
      'auth/invalid-credential': 'بيانات الدخول غير صحيحة',
      
      // أخطاء إنشاء الحساب
      'auth/email-already-in-use': 'هذا البريد الإلكتروني مُستخدم بالفعل',
      'auth/weak-password': 'كلمة المرور ضعيفة (6 أحرف على الأقل)',
      
      // أخطاء Social Login
      'auth/popup-blocked': 'تم حظر النافذة المنبثقة، حاول مرة أخرى',
      'auth/popup-closed-by-user': 'تم إغلاق النافذة المنبثقة',
      'auth/cancelled-popup-request': 'تم إلغاء العملية',
      'auth/account-exists-with-different-credential': 'يوجد حساب بهذا البريد بطريقة دخول مختلفة'
    };
    
    return errorMessages[errorCode] || 'حدث خطأ غير متوقع، حاول مرة أخرى';
  }

  // دالة تقييم قوة كلمة المرور
  function checkPasswordStrength(password) {
    const strengthIndicator = document.getElementById('passwordStrength');
    
    if (!password) {
      strengthIndicator.className = 'password-strength';
      return;
    }
    
    let strength = 0;
    
    if (password.length >= 6) strength++;
    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    if (strength <= 2) {
      strengthIndicator.className = 'password-strength weak';
    } else if (strength <= 4) {
      strengthIndicator.className = 'password-strength medium';
    } else {
      strengthIndicator.className = 'password-strength strong';
    }
  }

  // دالة عرض معلومات المستخدم الحالي
  function showCurrentUserInfo(user) {
    document.getElementById('currentUserName').textContent = user.displayName || 'مستخدم مسجل';
    document.getElementById('currentUserEmail').textContent = user.email;
    
    if (user.photoURL) {
      document.getElementById('currentUserAvatar').src = user.photoURL;
      document.getElementById('currentUserAvatar').style.display = 'block';
      document.getElementById('currentUserIcon').style.display = 'none';
    } else {
      document.getElementById('currentUserAvatar').style.display = 'none';
      document.getElementById('currentUserIcon').style.display = 'block';
    }
    
    currentUserInfo.style.display = 'block';
  }

  function hideCurrentUserInfo() {
    currentUserInfo.style.display = 'none';
  }

  // --- تسجيل الدخول بالبريد الإلكتروني ---
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isProcessingAuth) return;
    
    isProcessingAuth = true;
    setLoading(document.getElementById('loginBtn'), true);
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      showMessage('loginMsg', 'يرجى ملء جميع الحقول', 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('loginBtn'), false);
      return;
    }
    
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      
      // حفظ/تحديث بيانات المستخدم
      const isNew = await isNewUser(user);
      await saveUserToFirestore(user, isNew, { loginMethod: 'email' });
      
      showMessage('loginMsg', 'تم تسجيل الدخول بنجاح! جاري التحويل...', 'success');
      redirectToProfile();
      
    } catch (error) {
      console.error('Login error:', error);
      showMessage('loginMsg', getErrorMessage(error.code, 'login'), 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('loginBtn'), false);
    }
  });

  // --- إنشاء حساب جديد ---
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isProcessingAuth) return;
    
    isProcessingAuth = true;
    setLoading(document.getElementById('registerBtn'), true);
    
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const phone = document.getElementById('regPhone').value.trim();
    const agreeTerms = document.getElementById('agreeTerms').checked;
    
    if (!name || !email || !password) {
      showMessage('regMsg', 'يرجى ملء جميع الحقول المطلوبة', 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('registerBtn'), false);
      return;
    }
    
    if (!agreeTerms) {
      showMessage('regMsg', 'يجب الموافقة على الشروط والأحكام', 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('registerBtn'), false);
      return;
    }
    
    if (password.length < 6) {
      showMessage('regMsg', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('registerBtn'), false);
      return;
    }
    
    try {
      // إنشاء المستخدم
     // إنشاء المستخدم
const userCredential = await createUserWithEmailAndPassword(auth, email, password);
const user = userCredential.user;

// تحديث الملف الشخصي
await updateProfile(user, { displayName: name });

// حفظ بيانات المستخدم (مستخدم جديد) ← في الخلفية
saveUserToFirestore(user, true, { 
  name: name, 
  phone: phone, 
  loginMethod: 'email' 
}).catch(console.error); // أي خطأ يتسجل في الكونسول

// حول المستخدم فوراً
showMessage('regMsg', 'تم إنشاء الحساب بنجاح! جاري التحويل...', 'success');
redirectToProfile();

      
    } catch (error) {
      console.error('Registration error:', error);
      showMessage('regMsg', getErrorMessage(error.code, 'register'), 'error');
      isProcessingAuth = false;
      setLoading(document.getElementById('registerBtn'), false);
    }
  });

  // --- تسجيل الدخول بـ Google ---
  googleBtn.addEventListener('click', async () => {
    if (isProcessingAuth) return;
    
    isProcessingAuth = true;
    setLoading(googleBtn, true);
    
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
      prompt: 'select_account'
    });
    
    try {
      let result;
      
      // محاولة استخدام Popup أولاً
      try {
        result = await signInWithPopup(auth, provider);
      } catch (popupError) {
        // إذا فشل Popup، استخدم Redirect
        if (popupError.code === 'auth/popup-blocked' || 
            popupError.code === 'auth/popup-closed-by-user') {
          console.log('Popup blocked, using redirect...');
          await signInWithRedirect(auth, provider);
          return; // الخروج لأن الـ redirect سيتم التعامل معه في onAuthStateChanged
        }
        throw popupError;
      }
      
      // إذا نجح Popup
      const user = result.user;
      const isNew = await isNewUser(user);
      await saveUserToFirestore(user, isNew, { loginMethod: 'google' });
      
      showMessage('loginMsg', 'تم تسجيل الدخول بنجاح! جاري التحويل...', 'success');
      redirectToProfile();
      
    } catch (error) {
      console.error('Google sign-in error:', error);
      showMessage('loginMsg', getErrorMessage(error.code, 'google'), 'error');
      isProcessingAuth = false;
      setLoading(googleBtn, false);
    }
  });

  // --- تسجيل الدخول بـ Facebook ---
  facebookBtn.addEventListener('click', async () => {
    if (isProcessingAuth) return;
    
    isProcessingAuth = true;
    setLoading(facebookBtn, true);
    
    const provider = new FacebookAuthProvider();
    provider.addScope('email');
    
    try {
      let result;
      
      // محاولة استخدام Popup أولاً
      try {
        result = await signInWithPopup(auth, provider);
      } catch (popupError) {
        // إذا فشل Popup، استخدم Redirect
        if (popupError.code === 'auth/popup-blocked' || 
            popupError.code === 'auth/popup-closed-by-user') {
          console.log('Popup blocked, using redirect...');
          await signInWithRedirect(auth, provider);
          return; // الخروج لأن الـ redirect سيتم التعامل معه في onAuthStateChanged
        }
        throw popupError;
      }
      
      // إذا نجح Popup
      const user = result.user;
      const isNew = await isNewUser(user);
      await saveUserToFirestore(user, isNew, { loginMethod: 'facebook' });
      
      showMessage('loginMsg', 'تم تسجيل الدخول بنجاح! جاري التحويل...', 'success');
      redirectToProfile();
      
    } catch (error) {
      console.error('Facebook sign-in error:', error);
      showMessage('loginMsg', getErrorMessage(error.code, 'facebook'), 'error');
      isProcessingAuth = false;
      setLoading(facebookBtn, false);
    }
  });

  // --- إعادة تعيين كلمة المرور ---
  forgotPasswordLink.addEventListener('click', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) {
      showMessage('loginMsg', 'يرجى إدخال البريد الإلكتروني أولاً', 'error');
      return;
    }
    
    try {
      await sendPasswordResetEmail(auth, email);
      showMessage('loginMsg', 'تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني', 'success');
    } catch (error) {
      console.error('Password reset error:', error);
      showMessage('loginMsg', getErrorMessage(error.code, 'password-reset'), 'error');
    }
  });

  // --- مراقبة حالة المصادقة ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // المستخدم مسجل الدخول
      console.log('User is signed in:', user);
      showCurrentUserInfo(user);
      
      // إذا كان هذا نتيجة redirect من Social Login
      if (!isUserRedirected && !redirectInProgress) {
        const isNew = await isNewUser(user);
        await saveUserToFirestore(user, isNew, { 
          loginMethod: user.providerData[0]?.providerId || 'unknown' 
        });
        
        redirectToProfile();
      }
    } else {
      // المستخدم غير مسجل الدخول
      console.log('User is signed out');
      hideCurrentUserInfo();
    }
    
    // إعادة تعيين حالة المعالجة
    isProcessingAuth = false;
    setLoading(document.getElementById('loginBtn'), false);
    setLoading(document.getElementById('registerBtn'), false);
    setLoading(googleBtn, false);
    setLoading(facebookBtn, false);
  });

  // --- معالجة نتيجة الـ Redirect (لـ Social Login) ---
  getRedirectResult(auth)
    .then((result) => {
      if (result) {
        console.log('Redirect result received:', result);
      }
    })
    .catch((error) => {
      console.error('Redirect result error:', error);
      showMessage('loginMsg', getErrorMessage(error.code, 'redirect'), 'error');
    });

  // --- دالة تسجيل الخروج ---
  window.performLogout = async function() {
    try {
      await signOut(auth);
      showMessage('loginMsg', 'تم تسجيل الخروج بنجاح', 'success');
      hideCurrentUserInfo();
    } catch (error) {
      console.error('Logout error:', error);
      showMessage('loginMsg', 'حدث خطأ أثناء تسجيل الخروج', 'error');
    }
  };

  // --- مراقبة قوة كلمة المرور أثناء الكتابة ---
  document.getElementById('regPassword').addEventListener('input', (e) => {
    checkPasswordStrength(e.target.value);
  });

  // --- تحديث نص التذييل بناءً على التبويب النشط ---
  document.querySelectorAll('#authTabs button').forEach(tab => {
    tab.addEventListener('click', () => {
      const authFooterText = document.getElementById('authFooterText');
      if (tab.id === 'signin-tab') {
        authFooterText.innerHTML = 'ليس لديك حساب؟ <a href="#" onclick="document.getElementById(\'signup-tab\').click()">سجل الآن</a>';
      } else {
        authFooterText.innerHTML = 'لديك حساب بالفعل؟ <a href="#" onclick="document.getElementById(\'signin-tab\').click()">سجل الدخول</a>';
      }
    });
  });

  // --- منع إرسال النموذج عند الضغط على Enter في حقول غير زر الإرسال ---
  document.querySelectorAll('input').forEach(input => {
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.type !== 'submit') {
        e.preventDefault();
      }
    });
  });

  // --- التحقق من وجود بيانات محفوظة للتذكر ---
  document.addEventListener('DOMContentLoaded', () => {
    const savedEmail = localStorage.getItem('rememberedEmail');
    if (savedEmail) {
      document.getElementById('loginEmail').value = savedEmail;
      document.getElementById('remember').checked = true;
    }
  });

  // --- حفظ البريد الإلكتروني عند تفعيل التذكر ---
  document.getElementById('remember').addEventListener('change', (e) => {
    const email = document.getElementById('loginEmail').value.trim();
    if (e.target.checked && email) {
      localStorage.setItem('rememberedEmail', email);
    } else {
      localStorage.removeItem('rememberedEmail');
    }
  });

  // --- حفظ البريد الإلكتروني عند تغييره مع تفعيل التذكر ---
  document.getElementById('loginEmail').addEventListener('blur', () => {
    if (document.getElementById('remember').checked) {
      const email = document.getElementById('loginEmail').value.trim();
      if (email) {
        localStorage.setItem('rememberedEmail', email);
      }
    }
  });

  // --- تهيئة أولية ---
  console.log("Firebase Auth initialized");
</script>

</body>
</html>
